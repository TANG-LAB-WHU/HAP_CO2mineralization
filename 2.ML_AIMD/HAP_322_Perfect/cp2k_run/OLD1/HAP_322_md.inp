# TEMPLATE FILE: Template-HAP_322_md.inp
# This file will be processed by generate_config.py
# Placeholder: HAP_322 -> HAP_{hkl_param}

@SET PROJECT HAP_322

&GLOBAL
  EPS_CHECK_DIAG 1.0E-12
  PRINT_LEVEL LOW
  PROJECT_NAME ${PROJECT}_md
  RUN_TYPE MD
  &DBCSR  
    USE_MEMPOOLS_CPU .TRUE.
    MM_STACK_SIZE 50000
    USE_COMM_THREAD .TRUE.
    &ACC
      THREAD_BUFFERS 128
      MIN_FLOP_PROCESS 500
      MIN_FLOP_SORT 100
      BINNING_NBINS 16384
      BINNING_BINSIZE 16
      STACK_SORT .TRUE.
      PROCESS_INHOMOGENOUS .TRUE.
      AVOID_AFTER_BUSY .FALSE.
    &END ACC
  &END DBCSR
&END GLOBAL

&MOTION
  &MD
    ENSEMBLE NVT
    STEPS 200
    TEMPERATURE 973.0
    TIMESTEP 0.25
    &THERMOSTAT
      REGION GLOBAL
      TYPE CSVR
      &CSVR
        TIMECON 1.0
      &END CSVR
    &END THERMOSTAT
    &PRINT
      &ENERGY
        &EACH
          MD 1
        &END EACH
      &END ENERGY
    &END PRINT
  &END MD
  &PRINT
    &TRAJECTORY
      FILENAME =${PROJECT}_md-pos.xyz
      FORMAT XYZ
      &EACH
        MD 1
      &END EACH
    &END TRAJECTORY
    
    # Cell information for each MD step
    &CELL
      &EACH
        MD 1
      &END EACH
    &END CELL
  &END PRINT
&END MOTION

&FORCE_EVAL
  METHOD QS
  STRESS_TENSOR ANALYTICAL
  &DFT
    BASIS_SET_FILE_NAME BASIS_MOLOPT
    POTENTIAL_FILE_NAME GTH_POTENTIALS
    &MGRID
      CUTOFF 400
      REL_CUTOFF 60
      NGRIDS 4
    &END MGRID
    &QS
      METHOD GPW 
      EPS_DEFAULT 1.0E-12
      EXTRAPOLATION_ORDER 3
      EXTRAPOLATION ASPC 
    &END QS
    &SCF
      SCF_GUESS ATOMIC
      MAX_SCF 100
      EPS_SCF  1.0E-5
      &OT ON
        MINIMIZER DIIS
        PRECONDITIONER FULL_SINGLE_INVERSE
        ENERGY_GAP 0.08
      &END OT
      &OUTER_SCF
        MAX_SCF 50
        EPS_SCF 1.0E-5
      &END OUTER_SCF
      &PRINT
        &RESTART OFF
        &END RESTART
      &END PRINT
    &END SCF
    
    &POISSON
      PERIODIC XYZ
      POISSON_SOLVER PERIODIC
    &END POISSON
    
    &XC
      &XC_FUNCTIONAL
        &PBE
          PARAMETRIZATION PBESOL
        &END PBE
      &END XC_FUNCTIONAL
      ! Use DFT-D4 dispersion correction
      &VDW_POTENTIAL
        POTENTIAL_TYPE PAIR_POTENTIAL
        &PAIR_POTENTIAL
          TYPE DFTD4
          REFERENCE_FUNCTIONAL PBE
          ! D4 specific parameters
          D4_CUTOFF 20.0         ! 2-body cutoff in Angstrom
          D4_CN_CUTOFF 10.0      ! Coordination number cutoff
          R_CUTOFF 10.0          ! 3-body cutoff (actual cutoff = 2*R_CUTOFF)
          ! Use internal D4 implementation
          D4_REFERENCE_CODE TRUE
          &PRINT_DFTD
            ! Print D4 contributions
            COMMON_ITERATION_LEVELS 1
          &END PRINT_DFTD
        &END PAIR_POTENTIAL
      &END VDW_POTENTIAL
    &END XC
  &END DFT
  
  &SUBSYS
    &CELL
      ABC 32.645694 23.335159 25.455065     ! increase Z-direction vaccum layer to avoid mirror interactions
      PERIODIC XYZ           
      ALPHA_BETA_GAMMA [deg] 90.0 90.0 90.0
    &END CELL

    &COORD
      @include 'HAP_322_final.xyz'
    &END COORD

    &KIND Ca
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q10
    &END KIND

    &KIND P
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q5
    &END KIND

    &KIND O
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q6
    &END KIND

    &KIND C
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q4
    &END KIND

    &KIND H
      BASIS_SET TZV2P-MOLOPT-GTH 
      POTENTIAL GTH-PBE-q1
    &END KIND
  &END SUBSYS

  &PRINT  ! ########### FORCE_EVAL PRINT SECTION ###########
    &FORCES ON
      FILENAME  =${PROJECT}_forces.dat
      &EACH
        MD  1
      &END EACH
    &END FORCES
    &STRESS_TENSOR ON
      FILENAME  =${PROJECT}_virial.dat
      &EACH
        MD  1
      &END EACH
    &END STRESS_TENSOR
  &END PRINT

&END FORCE_EVAL