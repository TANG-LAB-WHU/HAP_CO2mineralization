@SET PROJECT HAP_304

&GLOBAL
  PROJECT_NAME ${PROJECT}_opt
  RUN_TYPE GEO_OPT
  PRINT_LEVEL LOW
&END GLOBAL

&MOTION
  &GEO_OPT
    TYPE MINIMIZATION
    OPTIMIZER LBFGS
    MAX_ITER 200            ! Moderate iterations for initial optimization
    MAX_FORCE 1.0E-3        ! Looser convergence for initial structure
    RMS_FORCE 5.0E-4
    &LBFGS
      MAX_H_RANK 20          
      TRUST_RADIUS 0.25
    &END LBFGS
  &END GEO_OPT
&END MOTION

&FORCE_EVAL
  METHOD Quickstep
  &DFT
    BASIS_SET_FILE_NAME BASIS_MOLOPT
    POTENTIAL_FILE_NAME GTH_POTENTIALS
    
    &MGRID
      CUTOFF 400            
      REL_CUTOFF 60
      NGRIDS 4
    &END MGRID
    
    &SCF
      SCF_GUESS ATOMIC
      EPS_SCF 1.0E-6        
      MAX_SCF 100
      
      &OT
        MINIMIZER DIIS
        PRECONDITIONER FULL_SINGLE_INVERSE
        ENERGY_GAP 0.08      ! Match the output
      &END OT
      
      &OUTER_SCF
        MAX_SCF 50
        EPS_SCF 1.0E-6
      &END OUTER_SCF
    &END SCF
    
    &QS
      METHOD GPW          
      EPS_DEFAULT 1.0E-12
      EXTRAPOLATION ASPC   ! Add for better initial guess
      EXTRAPOLATION_ORDER 3
    &END QS
    
    &POISSON
      PERIODIC XYZ
      POISSON_SOLVER PERIODIC
    &END POISSON
    
    &XC
      &XC_FUNCTIONAL PBE
      &END XC_FUNCTIONAL
      ! Use DFT-D4 dispersion correction
      &VDW_POTENTIAL
        POTENTIAL_TYPE PAIR_POTENTIAL
        &PAIR_POTENTIAL
          TYPE DFTD4
          REFERENCE_FUNCTIONAL PBE
          ! D4 specific parameters
          D4_CUTOFF 20.0         ! 2-body cutoff in Angstrom
          D4_CN_CUTOFF 10.0      ! Coordination number cutoff
          R_CUTOFF 10.0          ! 3-body cutoff (actual cutoff = 2*R_CUTOFF)
          ! Use internal D4 implementation
          D4_REFERENCE_CODE TRUE
          &PRINT_DFTD
            ! Print D4 contributions
            COMMON_ITERATION_LEVELS 1
          &END PRINT_DFTD
        &END PAIR_POTENTIAL
      &END VDW_POTENTIAL
    &END XC
  &END DFT
  
  &SUBSYS
    &CELL
      ABC 38.621588 18.848 26.561151
      PERIODIC XYZ
      ALPHA_BETA_GAMMA [deg] 90.0 90.0 90.0
    &END CELL
    
    &TOPOLOGY
      COORD_FILE_NAME ${PROJECT}_clean.xyz
      COORD_FILE_FORMAT XYZ
    &END TOPOLOGY
    
    &KIND Ca
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q10
    &END KIND
    
    &KIND P
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q5
    &END KIND
    
    &KIND O
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q6
    &END KIND
    
    &KIND C
      BASIS_SET DZVP-MOLOPT-SR-GTH
      POTENTIAL GTH-PBE-q4
    &END KIND
    
    &KIND H
      BASIS_SET TZV2P-MOLOPT-GTH     ! Better for OH groups
      POTENTIAL GTH-PBE-q1
    &END KIND
  &END SUBSYS
&END FORCE_EVAL
